import{j as e}from"./particles-CSzCUO-v.js";import{h as I,u as G,b as o}from"./vendor-BFu755QE.js";import{u as A}from"./useQuery-CnrhNLmL.js";import{t as E,s as j,a as L,l as q,m as H,b as F,c as v,d as Q,e as K}from"./d3-C953wjub.js";import{T as W,a1 as z}from"./services-BaVGtfnM.js";import{C as t}from"./index-BzGNHlk_.js";const ae=()=>{const{eventId:m}=I(),S=G(),p=o.useRef(null),[f,w]=o.useState(""),[g,C]=o.useState("all"),[R,Y]=o.useState("hour"),[r,T]=o.useState(null),{data:$}=A({queryKey:["event",m],queryFn:()=>W(m),enabled:!!m}),{data:x,isLoading:D}=A({queryKey:["event-scan-history",m],queryFn:()=>z(m),enabled:!!m}),O=o.useMemo(()=>x?Array.from(new Set(x.map(a=>a.scanned_by))):[],[x]),n=o.useMemo(()=>x?x.filter(a=>{if(f){const s=f.toLowerCase();if(!a.attendee_username.toLowerCase().includes(s)&&!a.scanned_by.toLowerCase().includes(s))return!1}if(g!=="all"&&a.scanned_by!==g)return!1;if(r){const s=new Date(a.scanned_at),l=new Date(r.start),i=new Date(r.end);if(s<l||s>i)return!1}return!0}):[],[x,f,g,r]),b=o.useMemo(()=>{if(r)return{start:new Date(r.start),end:new Date(r.end)};if(!n||n.length===0){const s=new Date;return{start:new Date(s.getTime()-1440*60*1e3),end:s}}const a=n.map(s=>new Date(s.scanned_at));return{start:new Date(Math.min(...a.map(s=>s.getTime()))),end:new Date(Math.max(...a.map(s=>s.getTime())))}},[n,r]),u=o.useMemo(()=>{if(!n||n.length===0)return[];const a=new Map;return n.forEach(s=>{const l=new Date(s.scanned_at);let i;switch(R){case"minute":i=E("%Y-%m-%d %H:%M")(l);break;case"hour":i=E("%Y-%m-%d %H:00")(l);break;case"day":i=E("%Y-%m-%d")(l);break}a.set(i,(a.get(i)||0)+1)}),Array.from(a.entries()).map(([s,l])=>({time:new Date(s),count:l})).sort((s,l)=>s.time.getTime()-l.time.getTime())},[n,R]);o.useEffect(()=>{if(!p.current||u.length===0)return;const a=j(p.current);a.selectAll("*").remove();const s={top:20,right:30,bottom:60,left:60},l=p.current.clientWidth-s.left-s.right,i=400-s.top-s.bottom,d=a.append("g").attr("transform",`translate(${s.left},${s.top})`),y=L().domain([b.start,b.end]).range([0,l]),h=q().domain([0,H(u,c=>c.count)||10]).nice().range([i,0]),M=F(y).ticks(8),B=v(h).ticks(6);d.append("g").attr("transform",`translate(0,${i})`).call(M).selectAll("text").attr("transform","rotate(-45)").style("text-anchor","end"),d.append("g").call(B),d.append("g").attr("class","grid").attr("opacity",.1).call(v(h).ticks(6).tickSize(-l).tickFormat(()=>""));const P=Q().x(c=>y(c.time)).y(c=>h(c.count)).curve(K);d.append("path").datum(u).attr("fill","none").attr("stroke","#3b82f6").attr("stroke-width",2).attr("d",P),d.selectAll(".dot").data(u).enter().append("circle").attr("class","dot").attr("cx",c=>y(c.time)).attr("cy",c=>h(c.count)).attr("r",4).attr("fill","#3b82f6").attr("stroke","white").attr("stroke-width",2).style("cursor","pointer").on("mouseenter",function(c,N){j(this).attr("r",6);const _=d.append("g").attr("class","tooltip").attr("transform",`translate(${y(N.time)},${h(N.count)-20})`);_.append("rect").attr("x",-40).attr("y",-25).attr("width",80).attr("height",20).attr("fill","black").attr("opacity",.8).attr("rx",4),_.append("text").attr("text-anchor","middle").attr("fill","white").attr("font-size","12px").text(`${N.count} scan${N.count>1?"s":""}`)}).on("mouseleave",function(){j(this).attr("r",4),d.selectAll(".tooltip").remove()}),d.append("text").attr("transform","rotate(-90)").attr("y",0-s.left).attr("x",0-i/2).attr("dy","1em").style("text-anchor","middle").style("fill","currentColor").text("Jumlah Scan"),d.append("text").attr("transform",`translate(${l/2},${i+s.bottom-5})`).style("text-anchor","middle").style("fill","currentColor").text("Waktu")},[u,b,R]);const k=a=>new Date(a).toLocaleString("id-ID",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}),X=()=>{T(null)};return e.jsx("div",{className:`min-h-screen ${t.BG_PRIMARY} p-6`,children:e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("button",{onClick:()=>S(`/dashboard/events/${m}`),className:`${t.TEXT_SECONDARY} hover:${t.TEXT_PRIMARY} mb-4 flex items-center`,children:"‚Üê Kembali ke Detail Acara"}),e.jsx("h1",{className:`text-3xl font-bold ${t.TEXT_PRIMARY} mb-2`,children:"Riwayat Scan QR"}),$&&e.jsxs("p",{className:t.TEXT_SECONDARY,children:["Acara: ",$.title]})]}),e.jsxs("div",{className:`${t.BG_SECONDARY} p-6 rounded-lg border ${t.BORDER} mb-6`,children:[e.jsx("h2",{className:`text-xl font-bold ${t.TEXT_PRIMARY} mb-4`,children:"Filter"}),e.jsxs("div",{className:"grid md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:`block text-sm font-medium ${t.TEXT_SECONDARY} mb-2`,children:"Cari"}),e.jsx("input",{type:"text",value:f,onChange:a=>w(a.target.value),placeholder:"Username atau scanner...",className:`w-full px-4 py-2 rounded-lg border ${t.BORDER} ${t.BG_PRIMARY} ${t.TEXT_PRIMARY}`})]}),e.jsxs("div",{children:[e.jsx("label",{className:`block text-sm font-medium ${t.TEXT_SECONDARY} mb-2`,children:"Scanner"}),e.jsxs("select",{value:g,onChange:a=>C(a.target.value),className:`w-full px-4 py-2 rounded-lg border ${t.BORDER} ${t.BG_PRIMARY} ${t.TEXT_PRIMARY}`,children:[e.jsx("option",{value:"all",children:"Semua Scanner"}),O.map(a=>e.jsx("option",{value:a,children:a},a))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:`block text-sm font-medium ${t.TEXT_SECONDARY} mb-2`,children:"Granularitas"}),e.jsxs("select",{value:R,onChange:a=>Y(a.target.value),className:`w-full px-4 py-2 rounded-lg border ${t.BORDER} ${t.BG_PRIMARY} ${t.TEXT_PRIMARY}`,children:[e.jsx("option",{value:"minute",children:"Per Menit"}),e.jsx("option",{value:"hour",children:"Per Jam"}),e.jsx("option",{value:"day",children:"Per Hari"})]})]}),e.jsx("div",{className:"flex items-end",children:e.jsx("button",{onClick:X,className:`w-full px-4 py-2 ${t.BG_ACCENT} ${t.TEXT_ON_ACCENT} rounded-lg hover:opacity-90`,children:"Reset Filter"})})]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:`block text-sm font-medium ${t.TEXT_SECONDARY} mb-2`,children:"Dari"}),e.jsx("input",{type:"datetime-local",value:(r==null?void 0:r.start)||"",onChange:a=>T(s=>({start:a.target.value,end:(s==null?void 0:s.end)||new Date().toISOString().slice(0,16)})),className:`w-full px-4 py-2 rounded-lg border ${t.BORDER} ${t.BG_PRIMARY} ${t.TEXT_PRIMARY}`})]}),e.jsxs("div",{children:[e.jsx("label",{className:`block text-sm font-medium ${t.TEXT_SECONDARY} mb-2`,children:"Sampai"}),e.jsx("input",{type:"datetime-local",value:(r==null?void 0:r.end)||"",onChange:a=>T(s=>({start:(s==null?void 0:s.start)||new Date(Date.now()-1440*60*1e3).toISOString().slice(0,16),end:a.target.value})),className:`w-full px-4 py-2 rounded-lg border ${t.BORDER} ${t.BG_PRIMARY} ${t.TEXT_PRIMARY}`})]})]})]}),e.jsxs("div",{className:`${t.BG_SECONDARY} p-6 rounded-lg border ${t.BORDER} mb-6`,children:[e.jsx("h2",{className:`text-xl font-bold ${t.TEXT_PRIMARY} mb-4`,children:"Grafik Time Series"}),D?e.jsx("div",{className:"flex items-center justify-center h-96",children:e.jsx("p",{className:t.TEXT_SECONDARY,children:"Memuat data..."})}):u.length===0?e.jsx("div",{className:"flex items-center justify-center h-96",children:e.jsx("p",{className:t.TEXT_SECONDARY,children:"Belum ada data scan"})}):e.jsx("svg",{ref:p,className:"w-full h-[400px]"})]}),e.jsxs("div",{className:`${t.BG_SECONDARY} p-6 rounded-lg border ${t.BORDER}`,children:[e.jsxs("h2",{className:`text-xl font-bold ${t.TEXT_PRIMARY} mb-4`,children:["Detail Riwayat (",(n==null?void 0:n.length)||0,")"]}),D?e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:t.TEXT_SECONDARY,children:"Memuat riwayat..."})}):!n||n.length===0?e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:t.TEXT_SECONDARY,children:"Belum ada riwayat scan"})}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:`border-b ${t.BORDER}`,children:[e.jsx("th",{className:`text-left py-3 px-4 ${t.TEXT_SECONDARY} font-medium`,children:"Peserta"}),e.jsx("th",{className:`text-left py-3 px-4 ${t.TEXT_SECONDARY} font-medium`,children:"Waktu Scan"}),e.jsx("th",{className:`text-left py-3 px-4 ${t.TEXT_SECONDARY} font-medium`,children:"Di-scan Oleh"}),e.jsx("th",{className:`text-left py-3 px-4 ${t.TEXT_SECONDARY} font-medium`,children:"Lokasi"}),e.jsx("th",{className:`text-left py-3 px-4 ${t.TEXT_SECONDARY} font-medium`,children:"Status"})]})}),e.jsx("tbody",{children:n.map((a,s)=>e.jsxs("tr",{className:`border-b ${t.BORDER} hover:bg-gray-50 dark:hover:bg-white/5 transition-colors`,children:[e.jsx("td",{className:`py-3 px-4 ${t.TEXT_PRIMARY}`,children:a.attendee_username}),e.jsx("td",{className:`py-3 px-4 ${t.TEXT_SECONDARY} text-sm`,children:k(a.scanned_at)}),e.jsx("td",{className:`py-3 px-4 ${t.TEXT_SECONDARY} text-sm`,children:a.scanned_by}),e.jsx("td",{className:`py-3 px-4 ${t.TEXT_SECONDARY} text-sm`,children:a.latitude&&a.longitude?e.jsx("a",{href:`https://www.google.com/maps?q=${a.latitude},${a.longitude}`,target:"_blank",rel:"noopener noreferrer",className:"text-blue-500 hover:text-blue-600 flex items-center",children:"üìç Lihat di Maps"}):e.jsx("span",{className:"text-gray-400",children:"-"})}),e.jsx("td",{className:"py-3 px-4",children:e.jsx("span",{className:`px-2 py-1 rounded text-xs ${a.attendee_status==="present"?"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200":"bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200"}`,children:a.attendee_status==="present"?"Hadir":"Terdaftar"})})]},a.id))})]})})]})]})})};export{ae as default};
