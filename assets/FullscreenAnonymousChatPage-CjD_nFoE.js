import{j as e}from"./particles-CSzCUO-v.js";import{b as a,L as Y}from"./vendor-BFu755QE.js";import{g as R,s as z,d as J}from"./chatService-BORdFYKP.js";import{w as d}from"./websocketService-CIB_-ktr.js";import"./index-BzGNHlk_.js";const X=()=>{const[m,u]=a.useState([]),[h,k]=a.useState(""),[i,b]=a.useState(null),[r,T]=a.useState(""),[c,x]=a.useState(!0),[S,o]=a.useState(null),[C,_]=a.useState(!1),[p,D]=a.useState(1),[$,y]=a.useState(!1),E=a.useRef(null),j=a.useRef(null),v=a.useRef(!1);a.useRef(0),a.useEffect(()=>{let s=localStorage.getItem("anonymous_sender_id");s||(s=`anon-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,localStorage.setItem("anonymous_sender_id",s)),T(s)},[]);const M=a.useMemo(()=>{const s={};return m.forEach(n=>{const l=new Date(n.created_at).toISOString().split("T")[0];s[l]||(s[l]=[]),s[l].push(n)}),s},[m]),H=a.useMemo(()=>Object.entries(M).sort(([s],[n])=>s.localeCompare(n)).map(([s,n])=>({dateKey:s,messages:n.sort((t,l)=>new Date(t.created_at).getTime()-new Date(l.created_at).getTime())})),[M]),P=a.useCallback(s=>{const n=new Date(s+"T00:00:00"),t=new Date,l=new Date(t);return l.setDate(l.getDate()-1),n.toDateString()===t.toDateString()?"Hari Ini":n.toDateString()===l.toDateString()?"Kemarin":n.toLocaleDateString("id-ID",{weekday:"long",day:"numeric",month:"long",year:n.getFullYear()!==t.getFullYear()?"numeric":void 0})},[]),B=a.useCallback(()=>{const s=j.current;return s?s.scrollHeight-s.scrollTop-s.clientHeight<100:!0},[]),N=a.useCallback(()=>{var s;(s=E.current)==null||s.scrollIntoView({behavior:"smooth"})},[]),w=a.useRef(()=>{});w.current=s=>{if(_(!0),s.type==="welcome"){typeof s.connections=="number"&&D(s.connections);return}if(s.type==="connections_update"){typeof s.connections=="number"&&D(s.connections);return}s.type==="new_message"?(u(n=>n.some(l=>l.id===s.message.id)?n:[...n,s.message]),setTimeout(()=>N(),100)):s.type==="clear_messages"&&u([])};const A=a.useCallback(()=>{if(!j.current)return;!B()&&!v.current&&(v.current=!0)},[B]),f=a.useCallback(()=>{v.current=!0},[]),g=a.useCallback(()=>{setTimeout(()=>{v.current=!1},100)},[]);a.useEffect(()=>{if(!r)return;(async()=>{x(!0),o(null);try{const l=await R();u(l),setTimeout(()=>N(),100)}catch(l){o(l.message||"Failed to load messages")}finally{x(!1)}})();const n=l=>{var L;(L=w.current)==null||L.call(w,l)};d.ensureConnected(),d.onMessage(n),_(d.isConnected);const t=j.current;return t&&(t.addEventListener("scroll",A),t.addEventListener("touchstart",f),t.addEventListener("touchend",g),t.addEventListener("mousedown",f),t.addEventListener("mouseup",g)),()=>{d.offMessage(n),_(!1),t&&(t.removeEventListener("scroll",A),t.removeEventListener("touchstart",f),t.removeEventListener("touchend",g),t.removeEventListener("mousedown",f),t.removeEventListener("mouseup",g))}},[r,A,f,g,N]);const F=async()=>{if(!(!h.trim()||!r)){o(null);try{if(d.isConnected)d.sendMessage({type:"send_message",sender_id:r,content:h.trim(),reply_to_id:i==null?void 0:i.id}),k(""),b(null);else{console.log("WebSocket not connected, using REST API fallback");const s={sender_id:r,content:h.trim()};i&&(s.reply_to_id=i.id),await z(s),k(""),b(null),await I()}}catch(s){o(s.message||"Failed to send message")}}},I=async()=>{x(!0),o(null);try{const s=await R();u(s),setTimeout(()=>N(),100)}catch(s){o(s.message||"Failed to load messages")}finally{x(!1)}},O=s=>{b(s)},K=()=>{b(null)},U=async()=>{try{x(!0),o(null),await J(),u([]),y(!1),d.isConnected&&d.sendMessage({type:"clear_messages",sender_id:r,content:"All messages have been cleared"})}catch(s){o(s.message||"Failed to delete messages")}finally{x(!1)}};return e.jsxs("div",{className:"min-h-screen bg-[#0a1014] text-white",children:[e.jsx("div",{className:"bg-[#1D4ED8] p-4 border-b border-[#2563EB]",children:e.jsxs("div",{className:"flex items-center justify-between max-w-6xl mx-auto",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(Y,{to:"/",className:"text-white hover:text-gray-300 text-xl",children:"â†"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-white/20 flex items-center justify-center text-white font-bold text-xl",children:"ðŸ’¬"}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-semibold",children:"Chat Anonim"}),e.jsxs("p",{className:"text-sm text-white/80 flex items-center gap-2",children:["Ruang chat publik â€¢ ",p," online",e.jsx("span",{className:`inline-block w-2 h-2 rounded-full ${C?"bg-green-400":"bg-red-400"}`}),C?"Terhubung":"Mencoba menghubungkan..."]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>y(!0),disabled:c||m.length===0,className:"px-3 py-2 rounded-lg text-white hover:bg-white/10 transition-colors disabled:opacity-50 disabled:cursor-not-allowed text-sm",title:"Hapus semua pesan",children:"ðŸ—‘ï¸ Reset Chat"}),e.jsx("button",{onClick:I,disabled:c,className:"px-3 py-2 rounded-lg text-white hover:bg-white/10 transition-colors disabled:opacity-50 text-sm",title:"Muat ulang pesan",children:c?"âŸ³":"ðŸ”„"})]})]})}),e.jsxs("div",{className:"flex max-w-6xl mx-auto h-[calc(100vh-80px)]",children:[e.jsxs("div",{className:"flex-1 flex flex-col",children:[e.jsxs("div",{ref:j,className:"flex-1 overflow-y-auto p-6 space-y-2",children:[S&&e.jsx("div",{className:"bg-red-500 text-white p-4 rounded-lg mb-4",children:S}),m.length===0&&!c&&e.jsxs("div",{className:"text-center text-gray-400 py-12",children:[e.jsx("div",{className:"text-6xl mb-4",children:"ðŸ’¬"}),e.jsx("div",{className:"text-xl mb-2",children:"Belum ada pesan"}),e.jsx("p",{className:"text-sm",children:"Jadilah yang pertama untuk mengatakan sesuatu!"})]}),m.length>0&&H.map(({dateKey:s,messages:n})=>e.jsxs("div",{children:[e.jsx("div",{className:"flex items-center justify-center my-6",children:e.jsx("div",{className:"bg-[#1f2c34] text-gray-300 text-xs px-4 py-2 rounded-full border border-[#2a3942]",children:P(s)})}),n.map(t=>{var l;return e.jsx("div",{className:`flex ${t.sender_id===r?"justify-end":"justify-start"} mb-2`,children:e.jsxs("div",{className:"flex flex-col max-w-[70%]",children:[e.jsxs("div",{className:`relative p-3 px-4 shadow-sm ${t.sender_id===r?"bg-[#1D4ED8] text-white rounded-tl-lg rounded-tr-lg rounded-bl-lg":"bg-[#1f2c34] text-gray-100 rounded-tl-lg rounded-tr-lg rounded-br-lg"}`,children:[e.jsx("div",{className:"text-sm mb-1 opacity-70 font-medium",children:t.sender_id===r?"Anda":`Anonim-${t.sender_id.slice(-6)}`}),t.reply_to_id&&t.reply_content&&e.jsxs("div",{className:`text-xs p-3 mb-3 rounded border-l-4 ${t.sender_id===r?"bg-[#1E40AF] border-[#3B82F6]":"bg-[#182229] border-[#3B82F6]"}`,children:[e.jsx("div",{className:"font-medium text-[#60A5FA] mb-1",children:t.reply_sender_id===r?"Anda":`Anonim-${(l=t.reply_sender_id)==null?void 0:l.slice(-6)}`}),e.jsx("div",{className:"truncate opacity-80",children:t.reply_content})]}),e.jsx("div",{className:"break-words text-base leading-relaxed",children:t.content}),e.jsx("div",{className:"flex items-center justify-end gap-2 mt-2",children:e.jsx("span",{className:"text-xs opacity-60",children:new Date(t.created_at).toLocaleTimeString("id-ID",{hour:"2-digit",minute:"2-digit"})})})]}),t.sender_id!==r&&e.jsx("button",{onClick:()=>O(t),className:"text-xs mt-1 ml-4 text-gray-400 hover:text-[#60A5FA] hover:underline transition-colors",children:"Balas"})]})},t.id)})]},s)),e.jsx("div",{ref:E})]}),e.jsxs("div",{className:"p-6 bg-[#1f2c34] border-t border-[#2a3942]",children:[i&&e.jsxs("div",{className:"mb-4 p-3 rounded-lg bg-[#2a3942] flex justify-between items-start border-l-4 border-[#3B82F6]",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"text-sm font-medium text-[#60A5FA] mb-1",children:["Membalas ",i.sender_id===r?"Anda":`Anonim-${i.sender_id.slice(-6)}`]}),e.jsx("div",{className:"text-sm truncate opacity-80 text-gray-300",children:i.content})]}),e.jsx("button",{onClick:K,className:"ml-3 text-gray-400 hover:text-red-500 transition-colors",children:"âœ•"})]}),e.jsxs("div",{className:"flex gap-3 items-center",children:[e.jsx("input",{type:"text",value:h,onChange:s=>k(s.target.value),onKeyPress:s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),F())},placeholder:"Ketik pesan anonim Anda...",className:"flex-1 px-4 py-3 rounded-full bg-[#2a3942] text-white focus:ring-2 focus:ring-[#3B82F6] focus:outline-none text-base"}),e.jsx("button",{onClick:F,disabled:!h.trim()||c,className:"p-3 rounded-full bg-[#2563EB] text-white hover:bg-[#1D4ED8] transition-colors disabled:opacity-50 disabled:cursor-not-allowed",title:"Kirim",children:e.jsx("svg",{className:"w-6 h-6",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"})})})]}),e.jsxs("div",{className:"text-xs text-gray-400 mt-3 flex items-center justify-between",children:[e.jsxs("span",{children:["Pesan Anda bersifat anonim. ID Anda: ",e.jsxs("span",{className:"font-mono text-[#60A5FA]",children:["Anonim-",r.slice(-6)]})]}),e.jsxs("span",{children:[m.length," pesan total"]})]})]})]}),e.jsxs("div",{className:"w-64 bg-[#1f2c34] border-l border-[#2a3942] flex flex-col",children:[e.jsxs("div",{className:"p-4 border-b border-[#2a3942]",children:[e.jsx("h3",{className:"text-lg font-semibold text-white mb-2",children:"Pengguna Online"}),e.jsxs("p",{className:"text-sm text-gray-400",children:[p," pengguna aktif"]})]}),e.jsxs("div",{className:"flex-1 p-4",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-3 p-3 rounded-lg bg-[#1D4ED8] border border-[#2563EB]",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-white/20 flex items-center justify-center text-white font-bold text-sm",children:"ðŸ‘¤"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-sm font-medium text-white",children:"Anda"}),e.jsx("div",{className:"text-xs text-green-400",children:"Online"})]})]}),Array.from({length:Math.max(0,p-1)},(s,n)=>e.jsxs("div",{className:"flex items-center gap-3 p-3 rounded-lg bg-[#2a3942] border border-[#37474f]",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-[#2563EB]/20 flex items-center justify-center text-[#60A5FA] font-bold text-sm",children:["ðŸ˜Š","ðŸ¤”","ðŸ˜„","ðŸ¤—","ðŸ˜Ž"][n%5]}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"text-sm font-medium text-gray-200",children:["Anonim-",String(n+1).padStart(3,"0")]}),e.jsx("div",{className:"text-xs text-green-400",children:"Online"})]})]},n))]}),p<=1&&e.jsxs("div",{className:"text-center text-gray-500 mt-8",children:[e.jsx("div",{className:"text-3xl mb-2",children:"ðŸ‘¥"}),e.jsx("div",{className:"text-sm",children:"Belum ada pengguna lain"})]})]})]})]}),$&&e.jsx("div",{className:"fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm px-4",children:e.jsxs("div",{className:"bg-[#1f2c34] border border-[#2a3942] relative w-full max-w-md rounded-xl p-6 shadow-2xl",children:[e.jsx("button",{type:"button",onClick:()=>y(!1),className:"absolute right-4 top-4 text-gray-400 hover:text-gray-600","aria-label":"Tutup konfirmasi",children:"âœ•"}),e.jsx("h2",{className:"text-xl font-semibold mb-4 text-white",children:"Hapus Semua Pesan?"}),e.jsx("p",{className:"text-gray-300 mb-6",children:"Tindakan ini akan menghapus semua pesan anonim secara permanen. Pesan yang sudah terkirim tidak dapat dikembalikan."}),e.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row",children:[e.jsx("button",{type:"button",onClick:()=>y(!1),className:"flex-1 px-4 py-3 rounded-lg font-semibold border border-[#2a3942] text-white hover:bg-black/20 transition-colors",children:"Batal"}),e.jsx("button",{type:"button",onClick:U,disabled:c,className:"flex-1 px-4 py-3 rounded-lg font-semibold bg-red-500 text-white hover:bg-red-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:c?"Menghapus...":"Ya, Hapus Semua"})]})]})})]})};export{X as default};
