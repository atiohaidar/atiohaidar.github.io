class o{constructor(){this.socket=null,this.messageHandlers=[],this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.reconnectInterval=1e3,this.isConnecting=!1,this.connectionTimeout=null,this.connectionPromise=null,this.messageQueue=[],this.batchTimeout=null,this.BATCH_DELAY=100,this.MAX_BATCH_SIZE=5,this.idleTimeout=null,this.lastActivity=Date.now(),this.IDLE_TIMEOUT=300*1e3}connect(){var s;if(this.isConnecting||((s=this.socket)==null?void 0:s.readyState)===WebSocket.CONNECTING)return;this.isConnecting=!0;let e;{const t="https://backend.atiohaidar.workers.dev",i=t.startsWith("https")?"wss:":"ws:",n=t.replace(/^https?:\/\//,"");e=`${i}//${n}/chat`}console.log("Attempting WebSocket connection to:",e);try{this.socket=new WebSocket(e),this.connectionTimeout=setTimeout(()=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.CONNECTING&&(console.warn("WebSocket connection timeout"),this.socket.close())},5e3),this.socket.onopen=()=>{console.log("WebSocket connected successfully"),this.connectionTimeout&&(clearTimeout(this.connectionTimeout),this.connectionTimeout=null),this.isConnecting=!1,this.reconnectAttempts=0,this.reconnectInterval=1e3,this.startIdleTimeout()},this.socket.onmessage=t=>{try{const i=JSON.parse(t.data);this.resetIdleTimeout(),this.messageHandlers.forEach(n=>n(i))}catch(i){console.error("Failed to parse WebSocket message:",i)}},this.socket.onclose=()=>{console.log("WebSocket disconnected"),this.connectionTimeout&&(clearTimeout(this.connectionTimeout),this.connectionTimeout=null),this.isConnecting=!1,this.attemptReconnect()},this.socket.onerror=t=>{console.error("WebSocket error:",t),this.connectionTimeout&&(clearTimeout(this.connectionTimeout),this.connectionTimeout=null),this.isConnecting=!1}}catch(t){console.error("Failed to create WebSocket connection:",t),this.isConnecting=!1,this.attemptReconnect()}}attemptReconnect(){if(this.reconnectAttempts>=this.maxReconnectAttempts){console.error("Max reconnection attempts reached");return}this.reconnectAttempts++,console.log(`Attempting to reconnect (${this.reconnectAttempts}/${this.maxReconnectAttempts})...`),setTimeout(()=>{this.connect()},this.reconnectInterval),this.reconnectInterval=Math.min(this.reconnectInterval*2,3e4)}onMessage(e){this.messageHandlers.includes(e)||this.messageHandlers.push(e)}ensureConnected(){!this.isConnected&&!this.isConnecting&&this.connect()}offMessage(e){const s=this.messageHandlers.indexOf(e);s>-1&&this.messageHandlers.splice(s,1)}hasHandler(e){return this.messageHandlers.includes(e)}get handlerCount(){return this.messageHandlers.length}sendMessage(e){if(this.resetIdleTimeout(),this.messageQueue.push(e),this.messageQueue.length>=this.MAX_BATCH_SIZE){this.flushBatch();return}this.batchTimeout||(this.batchTimeout=setTimeout(()=>{this.flushBatch()},this.BATCH_DELAY))}flushBatch(){var s;if(this.messageQueue.length===0)return;const e=[...this.messageQueue];this.messageQueue=[],this.batchTimeout&&(clearTimeout(this.batchTimeout),this.batchTimeout=null),((s=this.socket)==null?void 0:s.readyState)===WebSocket.OPEN?this.socket.send(JSON.stringify({type:"batch_messages",messages:e})):console.warn("WebSocket is not connected. Batch not sent.")}disconnect(){this.clearIdleTimeout(),this.flushBatch(),this.socket&&(this.socket.close(),this.socket=null),this.messageHandlers=[],this.reconnectAttempts=this.maxReconnectAttempts}startIdleTimeout(){this.clearIdleTimeout(),this.idleTimeout=setTimeout(()=>{console.log("WebSocket idle timeout reached, disconnecting..."),this.disconnect()},this.IDLE_TIMEOUT)}resetIdleTimeout(){this.lastActivity=Date.now(),this.idleTimeout&&this.startIdleTimeout()}clearIdleTimeout(){this.idleTimeout&&(clearTimeout(this.idleTimeout),this.idleTimeout=null)}get isConnected(){var e;return((e=this.socket)==null?void 0:e.readyState)===WebSocket.OPEN}}const h=new o;export{h as w};
